<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>超级飞机大战</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            overflow: hidden;
            background-color: #000;
            position: fixed;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #111;
        }
        
        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        #scoreDisplay {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
        }
        
        #levelDisplay {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 20px;
        }
        
        #weaponDisplay {
            position: absolute;
            top: 40px;
            left: 10px;
            color: white;
            font-size: 16px;
        }
        
        #bossWarning {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            text-align: center;
            color: red;
            font-size: 30px;
            transform: translateY(-50%);
            display: none;
            z-index: 150;
            text-shadow: 0 0 10px white;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        #bossHealthBar {
            position: absolute;
            top: 70px;
            left: 20%;
            width: 60%;
            height: 20px;
            background-color: #333;
            border: 2px solid #fff;
            display: none;
            z-index: 120;
        }
        
        #bossHealthFill {
            height: 100%;
            width: 100%;
            background-color: #e74c3c;
            transition: width 0.3s;
        }
        
        #joystickArea {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            z-index: 50;
            opacity: 0;
        }
        
        #weaponControls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: auto;
        }
        
        .weaponBtn {
            width: 60px;
            height: 40px;
            background-color: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .weaponBtn:hover, .weaponBtn:active {
            background-color: rgba(41, 128, 185, 0.9);
        }
        
        .weaponBtn.active {
            background-color: rgba(46, 204, 113, 0.7);
        }
        
        .weaponBtn.active:hover, .weaponBtn.active:active {
            background-color: rgba(39, 174, 96, 0.9);
        }
        
        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: white;
            pointer-events: auto;
        }
        
        #gameOver h1 {
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #restartBtn {
            padding: 10px 20px;
            font-size: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #restartBtn:hover {
            background-color: #45a049;
        }
        
        #fullHealthBtn {
            position: absolute;
            bottom: 235px;
            right: 10px;
            width: 60px;
            height: 40px;
            background-color: rgba(46, 204, 113, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            display: none;
            pointer-events: auto;
            transition: background-color 0.2s;
        }
        
        #fullHealthBtn:hover, #fullHealthBtn:active {
            background-color: rgba(39, 174, 96, 0.9);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="gameUI">
        <div id="scoreDisplay">分数: 0</div>
        <div id="levelDisplay">等级: 1</div>
        <div id="weaponDisplay">武器: 5弹道扇形</div>
        <div id="bossWarning">BOSS 来袭！</div>
        <div id="bossHealthBar"><div id="bossHealthFill"></div></div>
        
        <div id="weaponControls">
            <button class="weaponBtn active" data-weapon="spread">扇形</button>
            <button class="weaponBtn" data-weapon="laser">激光</button>
            <button class="weaponBtn" data-weapon="straight">6弹道</button>
            <button class="weaponBtn" data-weapon="missile">导弹</button>
            <button class="weaponBtn" data-weapon="super" style="display:none;">超级</button>
        </div>
        
        <button id="fullHealthBtn">满血</button>
    </div>
    
    <div id="joystickArea"></div>
    
    <div id="gameOver">
        <h1>游戏结束</h1>
        <p id="finalScore">最终分数: 0</p>
        <button id="restartBtn">重新开始</button>
    </div>

    <script>
        // 游戏变量
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const weaponDisplay = document.getElementById('weaponDisplay');
        const bossWarning = document.getElementById('bossWarning');
        const bossHealthBar = document.getElementById('bossHealthBar');
        const bossHealthFill = document.getElementById('bossHealthFill');
        const joystickArea = document.getElementById('joystickArea');
        const weaponControls = document.getElementById('weaponControls');
        const weaponBtns = document.querySelectorAll('.weaponBtn');
        const gameOverScreen = document.getElementById('gameOver');
        const finalScoreDisplay = document.getElementById('finalScore');
        const restartBtn = document.getElementById('restartBtn');
        const superWeaponBtn = document.querySelector('[data-weapon="super"]');
        const fullHealthBtn = document.getElementById('fullHealthBtn');
        
        // 调整画布大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // 游戏状态
        let gameRunning = true;
        let score = 0;
        let level = 1;
        let enemySpawnRate = 100;
        let enemySpeed = 2;
        let enemyHealth = 1;
        let enemyShootRate = 150;
        let bossActive = false;
        let bossSpawned = false;
        let bossDefeated = false;
        let bossSpawnScore = 2000;
        let fullHealthUnlocked = false;
        
        // 武器类型
        const WEAPON_TYPES = {
            SPREAD: 'spread',
            LASER: 'laser',
            STRAIGHT: 'straight',
            MISSILE: 'missile',
            SUPER: 'super'
        };
        
        let currentWeapon = WEAPON_TYPES.SPREAD;
        
        // 玩家飞机
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 100,
            width: 40,
            height: 50,
            speed: 8,
            color: '#3498db',
            isMoving: false,
            targetX: canvas.width / 2,
            targetY: canvas.height - 100,
            health: 3,
            maxHealth: 3,
            invincible: false,
            invincibleTimer: 0
        };
        
        // Boss
        const boss = {
            x: canvas.width / 2,
            y: -150,
            width: 100,
            height: 120,
            speed: 2,
            health: 0,
            maxHealth: 500,
            shootTimer: 0,
            moveTimer: 0,
            moveDirection: 1,
            active: false
        };
        
        // 子弹数组
        let bullets = [];
        let enemyBullets = [];
        let bossBullets = [];
        
        // 子弹属性
        const bulletProperties = {
            spread: {
                speed: 8,
                width: 4,
                height: 15,
                color: '#ff0000',
                cooldown: 10,
                count: 8,
                spreadAngle: 60
            },
            laser: {
                speed: 12,
                width: 8,
                height: 25,
                color: '#e74c3c',
                cooldown: 5,
                count: 6
            },
            straight: {
                speed: 10,
                width: 4,
                height: 15,
                color: '#2ecc71',
                cooldown: 8,
                count: 8
            },
            missile: {
                speed: 6,
                width: 8,
                height: 20,
                color: '#9b59b6',
                cooldown: 30,
                count: 5,
                explosionRadius: 60
            },
            super: {
                speed: 10,
                width: 6,
                height: 15,
                color: '#ff00ff',
                cooldown: 5,
                count: 18
            }
        };
        
        let bulletCooldown = 0;
        
        // 敌人数组
        let enemies = [];
        const enemyColors = ['#e74c3c', '#9b59b6', '#1abc9c', '#f39c12', '#d35400'];
        
        // 爆炸效果数组
        let explosions = [];
        
        // 摇杆控制
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoveX = 0;
        let touchMoveY = 0;
        let isTouching = false;
        let lastTouchTime = 0;
        
        // 初始化游戏
        function initGame() {
            gameRunning = true;
            score = 0;
            level = 1;
            enemySpawnRate = 100;
            enemySpeed = 2;
            enemyHealth = 1;
            enemyShootRate = 150;
            bossActive = false;
            bossSpawned = false;
            bossDefeated = false;
            bossSpawnScore = 2000;
            fullHealthUnlocked = false;
            
            player.x = canvas.width / 2;
            player.y = canvas.height - 100;
            player.isMoving = false;
            player.targetX = player.x;
            player.targetY = player.y;
            player.health = player.maxHealth;
            player.invincible = false;
            player.invincibleTimer = 0;
            
            boss.x = canvas.width / 2;
            boss.y = -150;
            boss.health = boss.maxHealth;
            boss.shootTimer = 0;
            boss.moveTimer = 0;
            boss.moveDirection = 1;
            boss.active = false;
            
            bullets = [];
            enemyBullets = [];
            bossBullets = [];
            enemies = [];
            explosions = [];
            
            currentWeapon = WEAPON_TYPES.SPREAD;
            updateWeaponDisplay();
            updateActiveWeaponBtn();
            superWeaponBtn.style.display = 'none';
            fullHealthBtn.style.display = 'none';
            bossHealthBar.style.display = 'none';
            bossWarning.style.display = 'none';
            
            scoreDisplay.textContent = `分数: ${score}`;
            levelDisplay.textContent = `等级: ${level}`;
            gameOverScreen.style.display = 'none';
            
            // 开始游戏循环
            requestAnimationFrame(gameLoop);
        }
        
        // 游戏主循环
        function gameLoop() {
            if (!gameRunning) return;
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 检查是否需要生成Boss
            checkBossSpawn();
            
            // 更新游戏状态
            updatePlayer();
            updateBullets();
            updateEnemyBullets();
            updateBossBullets();
            updateEnemies();
            updateBoss();
            updateExplosions();
            spawnEnemies();
            
            // 绘制游戏元素
            drawPlayer();
            drawBullets();
            drawEnemyBullets();
            drawBossBullets();
            drawEnemies();
            drawBoss();
            drawExplosions();
            
            // 检查碰撞
            checkCollisions();
            
            // 更新难度
            updateDifficulty();
            
            // 继续游戏循环
            requestAnimationFrame(gameLoop);
        }
        
        // 检查Boss生成
        function checkBossSpawn() {
            if (!bossSpawned && score >= bossSpawnScore) {
                bossSpawned = true;
                bossActive = true;
                boss.health = boss.maxHealth;
                boss.y = -150;
                boss.active = true;
                bossWarning.style.display = 'block';
                bossHealthBar.style.display = 'block';
                updateBossHealthBar();
                
                // 3秒后隐藏警告
                setTimeout(() => {
                    bossWarning.style.display = 'none';
                }, 3000);
            }
        }
        
        // 更新玩家位置
        function updatePlayer() {
            if (player.isMoving) {
                const dx = player.targetX - player.x;
                const dy = player.targetY - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > player.speed) {
                    player.x += dx / distance * player.speed;
                    player.y += dy / distance * player.speed;
                } else {
                    player.x = player.targetX;
                    player.y = player.targetY;
                }
            }
            
            // 边界检查
            player.x = Math.max(player.width / 2, Math.min(canvas.width - player.width / 2, player.x));
            player.y = Math.max(player.height / 2, Math.min(canvas.height - player.height / 2, player.y));
            
            // 无敌状态处理
            if (player.invincible) {
                player.invincibleTimer--;
                if (player.invincibleTimer <= 0) {
                    player.invincible = false;
                }
            }
            
            // 自动射击
            if (bulletCooldown <= 0) {
                shootBullets();
                bulletCooldown = bulletProperties[currentWeapon].cooldown;
            } else {
                bulletCooldown--;
            }
        }
        
        // 绘制玩家
        function drawPlayer() {
            ctx.save();
            
            // 无敌状态闪烁效果
            if (!player.invincible || Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.fillStyle = player.color;
                
                // 绘制飞机主体
                ctx.beginPath();
                ctx.moveTo(player.x, player.y - player.height / 2);
                ctx.lineTo(player.x + player.width / 2, player.y + player.height / 2);
                ctx.lineTo(player.x - player.width / 2, player.y + player.height / 2);
                ctx.closePath();
                ctx.fill();
                
                // 绘制飞机机翼
                ctx.beginPath();
                ctx.moveTo(player.x - player.width / 2, player.y - player.height / 4);
                ctx.lineTo(player.x - player.width, player.y);
                ctx.lineTo(player.x - player.width / 2, player.y + player.height / 4);
                ctx.closePath();
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(player.x + player.width / 2, player.y - player.height / 4);
                ctx.lineTo(player.x + player.width, player.y);
                ctx.lineTo(player.x + player.width / 2, player.y + player.height / 4);
                ctx.closePath();
                ctx.fill();
            }
            
            // 绘制玩家血条
            const healthBarWidth = player.width;
            const healthBarHeight = 5;
            
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(
                player.x - healthBarWidth / 2,
                player.y - player.height / 2 - 10,
                healthBarWidth,
                healthBarHeight
            );
            
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(
                player.x - healthBarWidth / 2,
                player.y - player.height / 2 - 10,
                healthBarWidth * (player.health / player.maxHealth),
                healthBarHeight
            );
            
            ctx.restore();
        }
        
        // 发射子弹（根据当前武器类型）
        function shootBullets() {
            const weapon = bulletProperties[currentWeapon];
            
            switch (currentWeapon) {
                case WEAPON_TYPES.SPREAD:
                    // 扇形发射5发子弹
                    const spreadAngle = weapon.spreadAngle * Math.PI / 180;
                    const angleStep = spreadAngle / (weapon.count - 1);
                    const startAngle = -spreadAngle / 2;
                    
                    for (let i = 0; i < weapon.count; i++) {
                        const angle = startAngle + i * angleStep;
                        const speedX = Math.sin(angle) * 2;
                        const speedY = -Math.cos(angle) * weapon.speed;
                        
                        bullets.push({
                            x: player.x,
                            y: player.y - player.height / 2,
                            width: weapon.width,
                            height: weapon.height,
                            speedX: speedX,
                            speedY: speedY,
                            color: weapon.color,
                            type: currentWeapon
                        });
                    }
                    break;
                    
                case WEAPON_TYPES.LASER:
                    // 直线激光
                    bullets.push({
                        x: player.x,
                        y: player.y - player.height / 2,
                        width: weapon.width,
                        height: weapon.height,
                        speedX: 0,
                        speedY: -weapon.speed,
                        color: weapon.color,
                        type: currentWeapon
                    });
                    break;
                    
                case WEAPON_TYPES.STRAIGHT:
                    // 6发直线子弹
                    const spacing = player.width / (weapon.count - 1);
                    const startX = player.x - player.width / 2;
                    
                    for (let i = 0; i < weapon.count; i++) {
                        bullets.push({
                            x: startX + i * spacing,
                            y: player.y - player.height / 2,
                            width: weapon.width,
                            height: weapon.height,
                            speedX: 0,
                            speedY: -weapon.speed,
                            color: weapon.color,
                            type: currentWeapon
                        });
                    }
                    break;
                    
                case WEAPON_TYPES.MISSILE:
                    // 导弹（有爆炸效果）
                    bullets.push({
                        x: player.x,
                        y: player.y - player.height / 2,
                        width: weapon.width,
                        height: weapon.height,
                        speedX: 0,
                        speedY: -weapon.speed,
                        color: weapon.color,
                        type: currentWeapon,
                        explosionRadius: weapon.explosionRadius
                    });
                    break;
                    
                case WEAPON_TYPES.SUPER:
                    // 18弹道无规则射击
                    for (let i = 0; i < weapon.count; i++) {
                        const angle = (Math.random() * Math.PI / 2) - Math.PI / 4; // -45到45度之间
                        const speedX = Math.sin(angle) * 5;
                        const speedY = -Math.cos(angle) * weapon.speed;
                        
                        bullets.push({
                            x: player.x,
                            y: player.y - player.height / 2,
                            width: weapon.width,
            height: weapon.height,
            speedX: speedX,
            speedY: speedY,
            color: weapon.color,
            type: currentWeapon
        });
    }
    break;
}
}

// 敌人发射子弹
function enemyShoot(enemy) {
    enemyBullets.push({
        x: enemy.x,
        y: enemy.y + enemy.height / 2,
        width: 6,
        height: 15,
        speed: 5 + Math.random() * 2,
        color: '#e74c3c'
    });
}

// Boss发射子弹
function bossShoot() {
    // 扇形子弹
    for (let i = 0; i < 5; i++) {
        const angle = (i * Math.PI / 6) - Math.PI / 3; // -60到60度之间
        const speedX = Math.sin(angle) * 3;
        const speedY = Math.cos(angle) * 4;
        
        bossBullets.push({
            x: boss.x,
            y: boss.y + boss.height / 2,
            width: 8,
            height: 20,
            speedX: speedX,
            speedY: speedY,
            color: '#ff0000'
        });
    }
    
    // 随机位置发射
    if (Math.random() < 0.3) {
        bossBullets.push({
            x: boss.x + (Math.random() - 0.5) * boss.width,
            y: boss.y + boss.height / 2,
            width: 10,
            height: 25,
            speedX: (Math.random() - 0.5) * 2,
            speedY: 4,
            color: '#ff6600'
        });
    }
}

// 更新子弹位置
function updateBullets() {
    for (let i = bullets.length - 1; i >= 0; i--) {
        bullets[i].x += bullets[i].speedX;
        bullets[i].y += bullets[i].speedY;
        
        // 移除超出屏幕的子弹
        if (bullets[i].y + bullets[i].height < 0 || 
            bullets[i].x < 0 || 
            bullets[i].x > canvas.width) {
            bullets.splice(i, 1);
        }
    }
}

// 更新敌人子弹位置
function updateEnemyBullets() {
    for (let i = enemyBullets.length - 1; i >= 0; i--) {
        enemyBullets[i].y += enemyBullets[i].speed;
        
        // 移除超出屏幕的子弹
        if (enemyBullets[i].y - enemyBullets[i].height > canvas.height) {
            enemyBullets.splice(i, 1);
        }
    }
}

// 更新Boss子弹位置
function updateBossBullets() {
    for (let i = bossBullets.length - 1; i >= 0; i--) {
        bossBullets[i].x += bossBullets[i].speedX;
        bossBullets[i].y += bossBullets[i].speedY;
        
        // 移除超出屏幕的子弹
        if (bossBullets[i].y - bossBullets[i].height > canvas.height ||
            bossBullets[i].x < 0 || 
            bossBullets[i].x > canvas.width) {
            bossBullets.splice(i, 1);
        }
    }
}

// 绘制子弹
function drawBullets() {
    ctx.save();
    bullets.forEach(bullet => {
        ctx.fillStyle = bullet.color;
        
        if (bullet.type === WEAPON_TYPES.LASER) {
            // 激光特殊绘制
            const gradient = ctx.createLinearGradient(
                bullet.x, bullet.y, 
                bullet.x, bullet.y + bullet.height
            );
            gradient.addColorStop(0, bullet.color);
            gradient.addColorStop(1, 'rgba(231, 76, 60, 0)');
            ctx.fillStyle = gradient;
            
            ctx.fillRect(
                bullet.x - bullet.width / 2, 
                bullet.y, 
                bullet.width, 
                bullet.height
            );
        } else {
            // 普通子弹绘制
            ctx.fillRect(
                bullet.x - bullet.width / 2, 
                bullet.y, 
                bullet.width, 
                bullet.height
            );
        }
    });
    ctx.restore();
}

// 绘制敌人子弹
function drawEnemyBullets() {
    ctx.save();
    enemyBullets.forEach(bullet => {
        ctx.fillStyle = bullet.color;
        ctx.fillRect(
            bullet.x - bullet.width / 2, 
            bullet.y, 
            bullet.width, 
            bullet.height
        );
    });
    ctx.restore();
}

// 绘制Boss子弹
function drawBossBullets() {
    ctx.save();
    bossBullets.forEach(bullet => {
        ctx.fillStyle = bullet.color;
        ctx.fillRect(
            bullet.x - bullet.width / 2, 
            bullet.y, 
            bullet.width, 
            bullet.height
        );
    });
    ctx.restore();
}

// 生成敌人
function spawnEnemies() {
    if (bossActive) return; // Boss战时暂停生成普通敌人
    
    if (Math.random() * enemySpawnRate < 1) {
        const size = 20 + Math.random() * 20;
        const health = Math.floor(enemyHealth);
        
        enemies.push({
            x: Math.random() * (canvas.width - size) + size / 2,
            y: -size,
            width: size,
            height: size,
            speed: enemySpeed + Math.random() * 1,
            color: enemyColors[Math.floor(Math.random() * enemyColors.length)],
            health: health,
            maxHealth: health,
            shootTimer: Math.floor(Math.random() * enemyShootRate)
        });
    }
}

// 更新敌人位置
function updateEnemies() {
    for (let i = enemies.length - 1; i >= 0; i--) {
        enemies[i].y += enemies[i].speed;
        
        // 敌人射击
        enemies[i].shootTimer--;
        if (enemies[i].shootTimer <= 0 && enemies[i].y > 0) {
            enemyShoot(enemies[i]);
            enemies[i].shootTimer = enemyShootRate;
        }
        
        // 移除超出屏幕的敌人
        if (enemies[i].y - enemies[i].height > canvas.height) {
            enemies.splice(i, 1);
        }
    }
}

// 更新Boss位置和行为
function updateBoss() {
    if (!boss.active) return;
    
    // Boss入场动画
    if (boss.y < 100) {
        boss.y += 1;
        return;
    }
    
    // Boss移动
    boss.moveTimer++;
    if (boss.moveTimer > 60) {
        boss.moveDirection *= -1;
        boss.moveTimer = 0;
    }
    
    boss.x += boss.moveDirection * boss.speed;
    
    // 边界检查
    if (boss.x < boss.width / 2) {
        boss.x = boss.width / 2;
        boss.moveDirection = 1;
    } else if (boss.x > canvas.width - boss.width / 2) {
        boss.x = canvas.width - boss.width / 2;
        boss.moveDirection = -1;
    }
    
    // Boss射击
    boss.shootTimer--;
    if (boss.shootTimer <= 0) {
        bossShoot();
        boss.shootTimer = 60 - level * 2; // 随等级提高射击频率
    }
}

// 绘制敌人
function drawEnemies() {
    ctx.save();
    enemies.forEach(enemy => {
        // 绘制敌人主体
        ctx.fillStyle = enemy.color;
        ctx.beginPath();
        ctx.moveTo(enemy.x, enemy.y - enemy.height / 2);
        ctx.lineTo(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
        ctx.lineTo(enemy.x - enemy.width / 2, enemy.y + enemy.height / 2);
        ctx.closePath();
        ctx.fill();
        
        // 绘制血条（如果敌人有多个生命值）
        if (enemy.maxHealth > 1) {
            const healthBarWidth = enemy.width;
            const healthBarHeight = 5;
            const healthPercentage = enemy.health / enemy.maxHealth;
            
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(
                enemy.x - healthBarWidth / 2,
                enemy.y - enemy.height / 2 - 10,
                healthBarWidth,
                healthBarHeight
            );
            
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(
                enemy.x - healthBarWidth / 2,
                enemy.y - enemy.height / 2 - 10,
                healthBarWidth * healthPercentage,
                healthBarHeight
            );
        }
    });
    ctx.restore();
}

// 绘制Boss
function drawBoss() {
    if (!boss.active) return;
    
    ctx.save();
    
    // 绘制Boss主体
    ctx.fillStyle = '#8e44ad';
    ctx.beginPath();
    ctx.moveTo(boss.x, boss.y - boss.height / 2);
    ctx.lineTo(boss.x + boss.width / 2, boss.y + boss.height / 2);
    ctx.lineTo(boss.x - boss.width / 2, boss.y + boss.height / 2);
    ctx.closePath();
    ctx.fill();
    
    // 绘制Boss装饰
    ctx.fillStyle = '#e74c3c';
    ctx.beginPath();
    ctx.arc(boss.x, boss.y - boss.height / 4, 15, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.restore();
}

// 更新Boss血条显示
function updateBossHealthBar() {
    const percentage = boss.health / boss.maxHealth;
    bossHealthFill.style.width = `${percentage * 100}%`;
}

// 创建爆炸效果
function createExplosion(x, y, size, color = '#f39c12') {
    const particles = [];
    const particleCount = 10 + Math.floor(Math.random() * 10);
    
    for (let i = 0; i < particleCount; i++) {
        particles.push({
            x: x,
            y: y,
            size: Math.random() * 3 + 1,
            color: color || `hsl(${Math.random() * 60 + 20}, 100%, 50%)`,
            speedX: (Math.random() - 0.5) * 5,
            speedY: (Math.random() - 0.5) * 5,
            life: 30 + Math.random() * 20
        });
    }
    
    explosions.push({
        x: x,
        y: y,
        particles: particles,
        maxLife: 50
    });
}

// 导弹爆炸效果
function createMissileExplosion(x, y, radius) {
    const particles = [];
    const particleCount = 30 + Math.floor(Math.random() * 20);
    
    for (let i = 0; i < particleCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * radius;
        
        particles.push({
            x: x + Math.cos(angle) * distance,
            y: y + Math.sin(angle) * distance,
            size: Math.random() * 5 + 2,
            color: `hsl(${Math.random() * 30 + 330}, 100%, 50%)`,
            speedX: (Math.random() - 0.5) * 3,
            speedY: (Math.random() - 0.5) * 3,
            life: 40 + Math.random() * 30
        });
    }
    
    explosions.push({
        x: x,
        y: y,
        particles: particles,
        maxLife: 70
    });
}

// Boss爆炸效果
function createBossExplosion(x, y) {
    const particles = [];
    const particleCount = 50 + Math.floor(Math.random() * 30);
    
    for (let i = 0; i < particleCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * 100;
        
        particles.push({
            x: x + Math.cos(angle) * distance,
            y: y + Math.sin(angle) * distance,
            size: Math.random() * 8 + 3,
            color: `hsl(${Math.random() * 60}, 100%, 50%)`,
            speedX: (Math.random() - 0.5) * 5,
            speedY: (Math.random() - 0.5) * 5,
            life: 60 + Math.random() * 40
        });
    }
    
    explosions.push({
        x: x,
        y: y,
        particles: particles,
        maxLife: 100
    });
}

// 更新爆炸效果
function updateExplosions() {
    for (let i = explosions.length - 1; i >= 0; i--) {
        explosions[i].particles.forEach(particle => {
            particle.x += particle.speedX;
            particle.y += particle.speedY;
            particle.life--;
        });
        
        explosions[i].maxLife--;
        
        if (explosions[i].maxLife <= 0) {
            explosions.splice(i, 1);
        }
    }
}

// 绘制爆炸效果
function drawExplosions() {
    ctx.save();
    explosions.forEach(explosion => {
        explosion.particles.forEach(particle => {
            if (particle.life > 0) {
                ctx.globalAlpha = particle.life / 30;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
            }
        });
    });
    ctx.restore();
}

// 检查碰撞
function checkCollisions() {
    // 子弹与敌人碰撞
    for (let i = bullets.length - 1; i >= 0; i--) {
        // 检查子弹与Boss碰撞
        if (boss.active && checkCollision(bullets[i], boss)) {
            boss.health--;
            updateBossHealthBar();
            bullets.splice(i, 1);
            
            if (boss.health <= 0) {
                // Boss被击败
                createBossExplosion(boss.x, boss.y);
                boss.active = false;
                bossActive = false;
                bossDefeated = true;
                bossHealthBar.style.display = 'none';
                score += 500;
                scoreDisplay.textContent = `分数: ${score}`;
                
                // 设置下一次Boss出现的分数
                bossSpawnScore += 2000;
                bossSpawned = false;
                
                // 检查是否解锁满血功能
                if (score >= 4000 && !fullHealthUnlocked) {
                    fullHealthUnlocked = true;
                    fullHealthBtn.style.display = 'block';
                }
                
                // 解锁超级武器（如果还没解锁）
                if (superWeaponBtn.style.display === 'none') {
                    superWeaponBtn.style.display = 'block';
                }
            }
            continue;
        }
        
        // 检查子弹与普通敌人碰撞
        for (let j = enemies.length - 1; j >= 0; j--) {
           
            if (checkCollision(bullets[i], enemies[j])) {
                // 导弹特殊处理
                if (bullets[i].type === WEAPON_TYPES.MISSILE) {
                    // 导弹爆炸，对范围内的敌人造成伤害
                    createMissileExplosion(bullets[i].x, bullets[i].y, bullets[i].explosionRadius);
                    
                    for (let k = enemies.length - 1; k >= 0; k--) {
                        const dx = enemies[k].x - bullets[i].x;
                        const dy = enemies[k].y - bullets[i].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < bullets[i].explosionRadius) {
                            enemies[k].health--;
                            
                            if (enemies[k].health <= 0) {
                                createExplosion(enemies[k].x, enemies[k].y, enemies[k].width);
                                enemies.splice(k, 1);
                                score += 10;
                                scoreDisplay.textContent = `分数: ${score}`;
                                
                                // 如果当前敌人是j，需要调整索引
                                if (k <= j) j--;
                            }
                        }
                    }
                    
                    // 移除导弹
                    bullets.splice(i, 1);
                    break;
                } else {
                    // 普通子弹处理
                    enemies[j].health--;
                    
                    // 移除子弹
                    bullets.splice(i, 1);
                    
                    // 如果敌人生命值为0，移除敌人并增加分数
                    if (enemies[j].health <= 0) {
                        createExplosion(enemies[j].x, enemies[j].y, enemies[j].width);
                        enemies.splice(j, 1);
                        score += 10;
                        scoreDisplay.textContent = `分数: ${score}`;
                    }
                    
                    break;
                }
            }
        }
    }
    
    // 敌人子弹与玩家碰撞
    if (!player.invincible) {
        for (let i = enemyBullets.length - 1; i >= 0; i--) {
            if (checkCollision(player, enemyBullets[i])) {
                player.health--;
                enemyBullets.splice(i, 1);
                
                if (player.health <= 0) {
                    createExplosion(player.x, player.y, player.width);
                    gameOver();
                    break;
                } else {
                    // 受伤后短暂无敌
                    player.invincible = true;
                    player.invincibleTimer = 60; // 1秒无敌时间
                }
            }
        }
        
        // Boss子弹与玩家碰撞
        for (let i = bossBullets.length - 1; i >= 0; i--) {
            if (checkCollision(player, bossBullets[i]) && !player.invincible) {
                player.health--;
                bossBullets.splice(i, 1);
                
                if (player.health <= 0) {
                    createExplosion(player.x, player.y, player.width);
                    gameOver();
                    break;
                } else {
                    // 受伤后短暂无敌
                    player.invincible = true;
                    player.invincibleTimer = 60;
                }
            }
        }
    }
    
    // 玩家与敌人碰撞
    if (!player.invincible) {
        for (let i = enemies.length - 1; i >= 0; i--) {
            if (checkCollision(player, enemies[i])) {
                player.health--;
                createExplosion(enemies[i].x, enemies[i].y, enemies[i].width);
                enemies.splice(i, 1);
                
                if (player.health <= 0) {
                    createExplosion(player.x, player.y, player.width);
                    gameOver();
                    break;
                } else {
                    // 受伤后短暂无敌
                    player.invincible = true;
                    player.invincibleTimer = 60;
                }
            }
        }
        
        // 玩家与Boss碰撞
        if (boss.active && checkCollision(player, boss) && !player.invincible) {
            player.health--;
            
            if (player.health <= 0) {
                createExplosion(player.x, player.y, player.width);
                gameOver();
            } else {
                // 受伤后短暂无敌
                player.invincible = true;
                player.invincibleTimer = 60;
            }
        }
    }
}

// 碰撞检测
function checkCollision(obj1, obj2) {
    return obj1.x < obj2.x + obj2.width / 2 &&
           obj1.x > obj2.x - obj2.width / 2 &&
           obj1.y < obj2.y + obj2.height / 2 &&
           obj1.y > obj2.y - obj2.height / 2;
}

// 更新游戏难度
function updateDifficulty() {
    const newLevel = Math.floor(score / 500) + 1;
    
    if (newLevel > level) {
        level = newLevel;
        levelDisplay.textContent = `等级: ${level}`;
    }
    
    // 随着分数增加，敌人生成频率增加，速度增加，生命值增加，射击频率增加
    enemySpawnRate = Math.max(30, 100 - level * 5);
    enemySpeed = 2 + level * 0.2;
    enemyHealth = 1 + Math.floor(level / 3);
    enemyShootRate = Math.max(50, 150 - level * 5);
}

// 游戏结束
function gameOver() {
    gameRunning = false;
    finalScoreDisplay.textContent = `最终分数: ${score}`;
    gameOverScreen.style.display = 'flex';
}

// 更新武器显示
function updateWeaponDisplay() {
    let weaponName = '';
    switch (currentWeapon) {
        case WEAPON_TYPES.SPREAD: weaponName = '5弹道扇形'; break;
        case WEAPON_TYPES.LASER: weaponName = '激光直线'; break;
        case WEAPON_TYPES.STRAIGHT: weaponName = '6弹道直线'; break;
        case WEAPON_TYPES.MISSILE: weaponName = '导弹范围伤害'; break;
        case WEAPON_TYPES.SUPER: weaponName = '18弹道超级武器'; break;
    }
    weaponDisplay.textContent = `武器: ${weaponName}`;
}

// 更新活动武器按钮
function updateActiveWeaponBtn() {
    weaponBtns.forEach(btn => {
        if (btn.dataset.weapon === currentWeapon) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

// 触摸控制
joystickArea.addEventListener('touchstart', function(e) {
    e.preventDefault();
    const now = Date.now();
    if (now - lastTouchTime < 16) return; // 限制触摸事件频率
    lastTouchTime = now;
    
    isTouching = true;
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    player.targetX = touchStartX;
    player.targetY = touchStartY;
    player.isMoving = true;
});

joystickArea.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (!isTouching) return;
    
    const touch = e.touches[0];
    player.targetX = touch.clientX;
    player.targetY = touch.clientY;
    player.isMoving = true;
});

joystickArea.addEventListener('touchend', function(e) {
    e.preventDefault();
    isTouching = false;
    player.isMoving = false;
});

// 武器切换按钮
weaponBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        currentWeapon = this.dataset.weapon;
        updateWeaponDisplay();
        updateActiveWeaponBtn();
        bulletCooldown = 0; // 立即可以射击
    });
});

// 满血按钮事件
fullHealthBtn.addEventListener('click', function() {
    if (fullHealthUnlocked) {
        player.health = player.maxHealth;
        // 添加绿色闪光效果
        createExplosion(player.x, player.y, player.width, '#2ecc71');
    }
});

// 重新开始按钮
restartBtn.addEventListener('click', initGame);

// 开始游戏
initGame();
</script>
</body>
</html>
